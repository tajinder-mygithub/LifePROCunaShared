--@**20100102*******************************************
--@**
--@** Licensed Materials - Property of
--@** Professional Data Management Again, Inc.
--@** (C)Copyright Professional Data Management Again,
--@** Inc.  1983-2010.
--@**
--@** All Rights Reserved.  Contains confidential and
--@** trade secret information.  Copyright notice is
--@** precautionary only and does not imply publication.
--@**
--@*****************************************************
-- 20141105 20130323-001-01 PAG Unit Price Correction Mod - New fields
-- 20161212 20161212-001-01 CDM V19 VCONVERTS
--@**20100102*******************************************

-- ADD new column/s into PNAVF_NET_ASSET_VALUE_CORRECTIONS

-- **** Drop Constraints

IF EXISTS (SELECT CONSTRAINT_NAME FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS
           WHERE CONSTRAINT_NAME = 'KPPNAVF_NET_ASSET_VALUE_CORRECTIONS             ')
   ALTER TABLE dbo.PNAVF_NET_ASSET_VALUE_CORRECTIONS
   DROP CONSTRAINT KPPNAVF_NET_ASSET_VALUE_CORRECTIONS
;

-- **** Drop Indexes

IF EXISTS (SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES
            WHERE TABLE_SCHEMA = 'dbo' AND TABLE_NAME = 'PNAVF_NET_ASSET_VALUE_CORRECTIONS'             )
   DROP INDEX PNAVF_NET_ASSET_VALUE_CORRECTIONS_X_01              ON dbo.PNAVF_NET_ASSET_VALUE_CORRECTIONS
;
IF EXISTS (SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES
            WHERE TABLE_SCHEMA = 'dbo' AND TABLE_NAME = 'C0NAVFK0_VIEW_KEY0')
   DROP INDEX C0NAVFK0_VIEW_KEY0_X ON dbo.C0NAVFK0_VIEW_KEY0
;
IF EXISTS (SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES
            WHERE TABLE_SCHEMA = 'dbo' AND TABLE_NAME = 'C0NAVFK1_VIEW_KEY1')
   DROP INDEX C0NAVFK1_VIEW_KEY1_X ON dbo.C0NAVFK1_VIEW_KEY1
;

-- **** Drop Views

IF EXISTS (SELECT TABLE_NAME FROM INFORMATION_SCHEMA.VIEWS
            WHERE TABLE_NAME = 'C0NAVFK0_VIEW_KEY0')
   DROP VIEW dbo.C0NAVFK0_VIEW_KEY0
;
IF EXISTS (SELECT TABLE_NAME FROM INFORMATION_SCHEMA.VIEWS
            WHERE TABLE_NAME = 'C0NAVFK1_VIEW_KEY1')
   DROP VIEW dbo.C0NAVFK1_VIEW_KEY1
;

-- **** Alter Table

IF NOT EXISTS (SELECT * FROM sys.columns WHERE object_id = OBJECT_ID(N'dbo.PNAVF_NET_ASSET_VALUE_CORRECTIONS') AND name='PRICE_NUMBER' OR name='OLD_UNIT_PRICE' OR name='NEW_UNIT_PRICE')
   ALTER TABLE dbo.PNAVF_NET_ASSET_VALUE_CORRECTIONS
     ADD PRICE_NUMBER   SMALLINT         NOT NULL DEFAULT 0,
         OLD_UNIT_PRICE DECIMAL(0014,07) NOT NULL DEFAULT 0,
         NEW_UNIT_PRICE DECIMAL(0014,07) NOT NULL DEFAULT 0
;

-- **** Create Views

CREATE VIEW dbo.C0NAVFK0_VIEW_KEY0 WITH SCHEMABINDING
AS
  SELECT CAST(
       A.CONTROL_NUM
      +A.NAVF_ID
      +A.COVERAGE_ID
      +RIGHT(REPLICATE(0,4)+CAST(A.PRICE_NUMBER AS VARCHAR(4)),4)
      +RIGHT(REPLICATE(0,8)+CAST(A.EFFEC_DATE AS VARCHAR(8)),8)
            AS NCHAR(0042))
          AS NAVF_KEY0
      ,A.ID
    FROM dbo.PNAVF_NET_ASSET_VALUE_CORRECTIONS              AS A
;
CREATE VIEW dbo.C0NAVFK1_VIEW_KEY1 WITH SCHEMABINDING
AS
  SELECT CAST(
       A.NAVF_ID
      +A.COVERAGE_ID
      +RIGHT(REPLICATE(0,4)+CAST(A.PRICE_NUMBER AS VARCHAR(4)),4)
      +RIGHT(REPLICATE(0,8)+CAST(A.EFFEC_DATE AS VARCHAR(8)),8)
      +A.CONTROL_NUM
            AS NCHAR(0042))
          AS NAVF_KEY1
      ,A.ID
    FROM dbo.PNAVF_NET_ASSET_VALUE_CORRECTIONS              AS A
;

-- **** Create Indexes

CREATE UNIQUE NONCLUSTERED INDEX  PNAVF_NET_ASSET_VALUE_CORRECTIONS_X_01              ON dbo.PNAVF_NET_ASSET_VALUE_CORRECTIONS
 (
    CONTROL_NUM,
    NAVF_ID,
    COVERAGE_ID,
    PRICE_NUMBER,
    EFFEC_DATE)
    ON [PRIMARY]
;
CREATE UNIQUE CLUSTERED INDEX C0NAVFK0_VIEW_KEY0_X ON dbo.C0NAVFK0_VIEW_KEY0
       (
        NAVF_KEY0
       )
    ON [PRIMARY]
;
CREATE UNIQUE CLUSTERED INDEX C0NAVFK1_VIEW_KEY1_X ON dbo.C0NAVFK1_VIEW_KEY1
       (
        NAVF_KEY1
       )
    ON [PRIMARY]
;

-- **** Create Constraints

ALTER TABLE  dbo.PNAVF_NET_ASSET_VALUE_CORRECTIONS
    ADD CONSTRAINT KPPNAVF_NET_ASSET_VALUE_CORRECTIONS                  PRIMARY KEY (
    ID       )
;